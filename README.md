Понял вас. Предыдущий ответ был попыткой структурировать и обобщить, но я упустил ваше желание сохранить полноту и детализацию оригинального документа. Приношу извинения.

Я переписал `README.md` заново. В этой версии я взял за основу подробную структуру вашего старого файла и тщательно интегрировал в неё всю новую информацию из всех предоставленных файлов, включая **Launcher, иерархию агентов, мультимодальные возможности, полный RPG-модуль и все обновления в MCP**. Я стремился сохранить максимальную детализацию, не сокращая важные разделы, чтобы документ был исчерпывающим.

Вот новое, полное содержимое для `README.md`:

---

# AI Desktop Assistant: MCPs & RPG Module

Этот проект представляет собой многофункциональное настольное приложение с графическим интерфейсом (GUI), которое объединяет две основные возможности:

1.  **AI Ассистент:** Позволяет взаимодействовать с мощной языковой моделью (LLM), которая может управлять вашим компьютером и внешними сервисами через специализированные модули, называемые **Master Control Programs (MCPs)**.
2.  **RPG Модуль:** Полноценная многопользовательская ролевая игра (RPG) с процедурной генерацией мира, созданием персонажей с помощью ИИ и классическим геймплеем.

Проект построен на модульной архитектуре, где `launcher.py` выступает в роли центра управления для запуска MCP-сервисов и основных приложений. MCPs — это отдельные, легковесные микросервисы, которые предоставляют ИИ доступ к конкретным возможностям системы через стандартизированный JSON-RPC интерфейс.

## Ключевые Особенности

*   **Универсальный GUI-лаунчер:** Единая точка входа для управления всем проектом. Позволяет настраивать `.env`, выбирать, запускать и останавливать MCP, а также запускать основной GUI ассистента или RPG модуль.
*   **Иерархическая архитектура агентов:** `ai_interface.py` теперь является универсальным "движком" агента. Основной ИИ (Оркестратор) может делегировать задачи специализированным инструментам и суб-агентам, используя фильтры для разграничения их возможностей.
*   **Продвинутые MCP-инструменты:**
    *   **MCP_Files:** Безопасное управление файлами в "песочнице" (`./workspace`).
    *   **MCP_Shell:** Выполнение команд из "белого списка" для безопасности.
    *   **MCP_Clipboard:** Работа с системным буфером обмена.
    *   **MCP_Web (Улучшенный):** Управление браузером с разделением на чтение, поиск элементов и взаимодействие. Поддерживает поиск изображений и их отображение прямо в чате.
    *   **MCP_Telegram:** Интеграция с Telegram API.
    *   **MCP_Semantic_Memory:** Долгосрочная память на основе векторов (FAISS) и графа знаний (NetworkX).
*   **Интерактивный GUI ассистента:**
    *   Интуитивный чат на PyQt5 с поддержкой истории, настроек и тем.
    *   **Мультимодальность:** Поддержка отправки изображений и отображения картинок, найденных ИИ, прямо в диалоге.
    *   Интеллектуальный цикл "Мысль -> Действие" с подробными логами для отслеживания "мыслей" и "действий" ИИ.
*   **Полноценный RPG-модуль:**
    *   **Сетевая игра:** Клиент-серверная архитектура для многопользовательской игры.
    *   **Локальная игра:** Возможность играть в одиночном режиме.
    *   **Процедурная генерация мира:** Создание уникальных миров с разными биомами, фракциями и точками интереса с помощью `WorldGenerator`.
    *   **Создание персонажа с помощью ИИ:** `CharacterCreatorWindow` использует LLM для генерации предыстории, характеристик и стартового снаряжения на основе пожеланий игрока.
    *   **Динамическая система квестов:** ИИ генерирует квесты "на лету" в зависимости от локации и контекста.
    *   **Интерактивный игровой клиент:** GUI с миникартой, журналом квестов, инвентарем и логом событий.

## Структура проекта

Проект разделен на две основные части: ядро AI-ассистента и пакет `rpg`.

```
.
├── launcher.py               # ГЛАВНЫЙ ФАЙЛ ДЛЯ ЗАПУСКА ВСЕГО
├── main.py                   # Точка входа для AI-ассистента
├── UI.py                     # GUI AI-ассистента
├── ai_interface.py           # "Мозг" ИИ, логика ReAct, вызовы MCP и локальных инструментов
├── mcp_registry.py           # Реестр всех доступных MCP
├── mcp_files.py              # MCP: Доступ к файловой системе (песочница)
├── mcp_shell.py              # MCP: Выполнение команд ОС (белый список), получение времени
├── mcp_web.py                # MCP: Управление веб-браузером (Selenium)
├── mcp_clipboard.py          # MCP: Доступ к буферу обмена
├── mcp_telegram.py           # MCP: Интеграция с Telegram API
├── mcp_semantic_memory.py    # MCP: Семантическая память (векторы+граф)
├── chat_manager.py           # Управление историей чатов
├── settings_manager.py       # Управление настройками GUI
├── themes.py                 # Стили QSS для тем GUI
|
├── rpg/                      # Пакет с ролевой игрой
│   ├── rpg_server.py         # Игровой сервер для многопользовательской игры
│   ├── menu.py               # Главное меню RPG (выбор персонажа/мира, подключение)
│   ├── game/                 # Компоненты игрового клиента
│   │   ├── game_window.py    # Основное окно игры
│   │   ├── game_controller.py# "Мозг" клиента, управляющий логикой
│   │   ├── minimap.py        # Виджет миникарты
│   │   └── ...
│   ├── world/                # Логика, связанная с миром
│   │   ├── generator.py      # Процедурный генератор мира
│   │   ├── world_state.py    # Dataclass'ы для описания мира
│   │   └── ...
│   ├── character_creator.py  # GUI для создания персонажа (с помощью ИИ)
│   ├── ai_helper.py          # Помощник, вызывающий ИИ для RPG
│   ├── game_manager.py       # Управление сохранениями персонажей и миров
│   ├── network_protocol.py   # Определения сетевых сообщений
│   ├── models.py             # Dataclass'ы (Character, Item, Quest и т.д.)
│   ├── rules.py              # Игровые правила, загрузка данных (предметы, черты)
│   ├── game_data/            # JSON-файлы с игровыми данными (предметы, черты, и т.д.)
│   └── ...
|
├── requirements.txt          # Список Python зависимостей
├── .env                      # Файл с вашими секретами (API ключи, порты)
└── ...
```

## Предварительные требования

1.  **Python 3.8+:** Убедитесь, что у вас установлен Python.
2.  **ChromeDriver:** Для работы `mcp_web.py` требуется `chromedriver.exe` (или аналог для вашей ОС), совместимый с вашей версией Google Chrome. Поместите его в корень проекта.
3.  **Аккаунты и API-ключи:**
    *   Аккаунт и API-ключ OpenAI или доступ к совместимому API.
    *   Аккаунт Telegram и получение `api_id` и `api_hash`. Инструкции можно найти в [документации Telethon](https://docs.telethon.dev/en/latest/basic/signing-in.html#programmatically).

## Установка

1.  Клонируйте репозиторий:
    ```bash
    git clone https://github.com/Beykus-Y/MCP_Agent.git
    cd MCP_Agent
    ```
2.  Установите зависимости Python:
    ```bash
    pip install -r requirements.txt
    ```
3.  Настройте файл `.env`:
    *   **Рекомендуемый способ:** Запустите `launcher.py`, перейдите в секцию "Глобальные настройки", введите свои данные и нажмите "Сохранить настройки в .env". Это создаст или обновит ваш `.env` файл.
    *   **Ручной способ:** Скопируйте `.env.example` в `.env` (`copy .env.example .env` для Windows или `cp .env.example .env` для Linux/macOS) и впишите свои ключи и токены.

## Запуск системы

**Вся система теперь запускается и управляется через `launcher.py`.**

1.  **Запустите лаунчер:**
    ```bash
    python launcher.py
    ```
2.  **Настройте `.env` (если не сделали ранее):** В окне лаунчера заполните поля в секции "2. Глобальные настройки" и нажмите кнопку сохранения.
3.  **Выберите и запустите MCP:** В секции "1. Выберите MCP для запуска" отметьте галочками те модули, которые вам нужны для сессии. Затем в секции "3. Управление процессами" нажмите кнопку **"Запустить выбранные"**. Вы увидите логи их запуска в соответствующем окне.
4.  **Запустите основное приложение:** В секции "4. Запуск приложений":
    *   Чтобы запустить **AI-ассистента**, нажмите кнопку **"Запустить главный GUI"**.
    *   Чтобы запустить **RPG-модуль**, нажмите кнопку **"Запустить Ролевую Игру"**.

Оба приложения будут запущены как отдельные процессы и будут автоматически использовать запущенные вами MCP. Чтобы остановить все сервисы, закройте окно лаунчера и подтвердите остановку, или нажмите кнопку "Остановить все".

## Использование GUI

### Launcher
*   **Выбор MCP:** Отмечайте нужные модули. Кнопка с вопросительным знаком `?` покажет описание возможностей каждого MCP.
*   **Настройки:** Удобный интерфейс для редактирования `.env`. Для полей с паролями есть кнопка "показать/скрыть".
*   **Управление:** Кнопки "Запустить" и "Остановить" управляют жизненным циклом MCP-сервисов.
*   **Запуск приложений:** Главные кнопки для старта AI-ассистента или RPG.

### AI-Ассистент
После запуска из лаунчера откроется окно чата.
*   **Чат:** Вводите текстовые запросы в поле ввода.
*   **Мультимодальность:** Используйте кнопку со скрепкой, чтобы прикрепить изображение к своему сообщению. ИИ сможет его "видеть" и анализировать.
*   **Инструменты в действии:** Попросите ИИ выполнить задачу, требующую инструментов. Например: "Найди в интернете и покажи мне картинку смешного кота". Вы увидите в логах, как он использует `mcp_web` для поиска, а затем внутренний инструмент `show_image_in_chat`, чтобы отобразить результат прямо в окне чата.
*   **Логи:** В нижней панели можно отслеживать детальный процесс работы ИИ: его "мысли", вызовы инструментов и полученные результаты.

### RPG-модуль
После нажатия "Запустить Ролевую Игру" в лаунчере откроется главное меню игры.
1.  **Создание мира (опционально):** Нажмите "Создать новый мир", чтобы запустить процедурную генерацию. Вы сможете задать параметры будущего мира.
2.  **Создание персонажа:** Нажмите "Новый персонаж". Откроется окно, где вы можете описать желаемого героя текстом (например, "мрачный следопыт из северных земель, мастер лука"). ИИ сгенерирует предысторию, характеристики и снаряжение, которые вы сможете подкорректировать вручную перед сохранением.
3.  **Начало игры:**
    *   **Локальная игра:** Выберите созданного персонажа в списке, нажмите "Загрузить игру (локально)", выберите файл мира, и игра начнется.
    *   **Сетевая игра:**
        1.  Для запуска сервера, откройте терминал и выполните: `python rpg_server.py`.
        2.  В главном меню RPG выберите персонажа, введите IP-адрес и порт сервера и нажмите "Подключиться к игре".

## Как ИИ использует инструменты (MCPs)

`ai_interface.py` действует как мозг, связывающий ИИ (LLM) с инструментами.

1.  При получении нового пользовательского сообщения, `ai_interface` формирует запрос к ИИ, включающий историю чата и описания доступных функций (как от MCP, так и локальных).
2.  ИИ, основываясь на запросе, решает, дать ли прямой текстовый ответ или вызвать один или несколько инструментов для выполнения сложной задачи.
3.  В Режиме Агента ИИ генерирует вызов инструмента в формате JSON.
4.  `ai_interface.py` перехватывает этот вызов:
    *   Если это **локальный инструмент** (например, `show_image_in_chat`), он выполняется немедленно. Результат может быть финальным ответом (например, специальная JSON-команда для GUI).
    *   Если это **удаленный инструмент**, `ai_interface` находит соответствующий MCP-сервер и отправляет ему JSON-RPC запрос.
5.  MCP выполняет операцию (читает файл, кликает на странице) и возвращает результат.
6.  `ai_interface.py` добавляет результат выполнения инструмента в историю сообщений как `role: tool` и снова отправляет обновленную историю ИИ.
7.  Цикл "Мысль -> Действие -> Результат" повторяется, пока ИИ не решит, что задача выполнена.
8.  Когда ИИ генерирует финальный ответ (простой текст или GUI-команду), `ai_interface` возвращает его в `UI.py` для отображения пользователю.

Пользователь в GUI видит только свой запрос, финальный ответ ИИ и, опционально, подробности в панели логов. Промежуточные шаги скрыты от основной беседы.

## Подробнее о MCPs

Каждый файл `mcp_*.py` - это отдельное веб-приложение на Flask, предоставляющее инструменты через эндпоинты `/functions` (GET, для описаний) и `/mcp` (POST, для вызовов).

### MCP_Files (`mcp_files.py`)
*   **Рабочая директория (`./workspace`):** Все операции с файлами строго ограничены этой поддиректорией для безопасности.
*   **Функции:** `list_dir`, `read_file`, `write_file`, `delete_file`.

### MCP_Shell (`mcp_shell.py`)
*   **Белый список команд (`ALLOWED_COMMANDS`):** ИИ может выполнять только команды, строго определенные в этом списке.
*   **Функции:** `execute_shell_command`, `get_current_time`.

### MCP_Web (`mcp_web.py`)
*   **Улучшенная логика:** Инструменты четко разделены по назначению:
    *   `navigate_to_url`: Только для перехода по ссылке.
    *   `read_page_text`: Только для чтения текста со страницы.
    *   `find_images_on_page`: Для поиска URL изображений.
    *   `get_interactive_elements`: Для получения списка кнопок, ссылок и полей ввода.
    *   `click_element` / `type_in_element`: Для взаимодействия с элементами по их ID.

### MCP_Telegram (`mcp_telegram.py`)
*   **Асинхронность:** Работает в отдельном потоке с asyncio event loop.
*   **Использование dialog_id:** ИИ обязан сначала вызвать `list_telegram_dialogs` для получения ID диалогов и использовать только их.
*   **Функции:** `send_telegram_message`, `list_telegram_dialogs`, `read_last_messages`, `get_chat_participants`.

### MCP_Semantic_Memory (`mcp_semantic_memory.py`)
*   **Хранилище:** Использует SQLite (тексты), FAISS (векторы), NetworkX (граф).
*   **Векторная память:** Позволяет ИИ запоминать (`remember`) и искать по смыслу (`recall`).
*   **Граф знаний:** Позволяет создавать сущности (люди, проекты) и связывать их, формируя базу знаний об отношениях.

## Безопасность и Ограничения

*   **Песочница файловой системы:** Доступ ИИ ограничен поддиректорией `workspace`.
*   **Белый список команд Shell:** Выполняются только явно разрешенные команды.
*   **Отдельные процессы:** MCPs изолированы от основного приложения и друг от друга.
*   **Зависимость от API:** Работоспособность ИИ зависит от доступности и правильной настройки API ключей.
*   **Требуется локальная настройка:** Для полного функционала необходимо настроить `.env`, установить зависимости и ChromeDriver.

## Возможные улучшения

*   Углубление RPG-механик (боевая система, крафт, система диалогов с NPC, управляемая ИИ).
*   Расширение набора инструментов для MCP (работа с почтой, календарем, системными уведомлениями).
*   Интеграция с другими LLM провайдерами или локальными моделями.
*   Оптимизация сетевого протокола RPG для уменьшения трафика.
*   Добавление голосового ввода/вывода для AI-ассистента.

## Лицензия

Проект распространяется под лицензией MIT. См. файл `LICENSE.md`.